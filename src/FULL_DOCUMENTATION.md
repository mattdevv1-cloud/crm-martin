# 📚 Полная документация CRM-системы для онлайн-магазина техники

## 📋 Содержание

1. [Обзор системы](#обзор-системы)
2. [Архитектура](#архитектура)
3. [Роли пользователей](#роли-пользователей)
4. [Функциональные модули](#функциональные-модули)
5. [Технический стек](#технический-стек)
6. [Мобильная версия и PWA](#мобильная-версия-и-pwa)
7. [Интеграции](#интеграции)
8. [Backend и API](#backend-и-api)
9. [Безопасность](#безопасность)
10. [Развертывание](#развертывание)
11. [Руководство пользователя](#руководство-пользователя)

---

## 🎯 Обзор системы

### Назначение
CRM-система для управления онлайн-магазином техники с полным циклом обработки заказов: от приёма заказа до доставки клиенту.

### Ключевые возможности
- ✅ Управление заказами с полным жизненным циклом
- ✅ Складской учёт с серийными номерами
- ✅ Автоматическое резервирование товаров
- ✅ Планирование и отслеживание доставок
- ✅ Мобильное приложение для курьеров (PWA)
- ✅ Интеграция с Яндекс.Картами
- ✅ Офлайн-режим для курьеров
- ✅ Полный аудит всех операций
- ✅ Аналитика и отчёты по продажам
- ✅ 5 ролей пользователей с гибкими правами доступа

### Целевая аудитория
- Администраторы
- Менеджеры продаж
- Кладовщики
- Бухгалтеры/аналитики
- Курьеры

---

## 🏗️ Архитектура

### Общая архитектура

```
┌─────────────────────────────────────────────────────────┐
│                    Frontend (React)                      │
│  ┌─────────────┐  ┌──────────────┐  ┌────────────────┐ │
│  │  Desktop UI  │  │  Mobile UI   │  │  PWA Features  │ │
│  └─────────────┘  └──────────────┘  └────────────────┘ │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│              Supabase Edge Functions (Hono)              │
│                     Backend Server                        │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                   Supabase Services                       │
│  ┌──────────┐  ┌─────────┐  ┌────────┐  ┌───────────┐ │
│  │   Auth   │  │  DB/KV  │  │ Storage│  │  Realtime │ │
│  └──────────┘  └─────────┘  └────────┘  └───────────┘ │
└─────────────────────────────────────────────────────────┘
```

### Структура проекта

```
/
├── App.tsx                    # Главный компонент приложения
├── components/                # React компоненты
│   ├── Audit.tsx             # Аудит операций
│   ├── AuthContext.tsx       # Контекст авторизации
│   ├── CalendarView.tsx      # Календарь доставок
│   ├── CourierBottomSheet.tsx# Bottom sheet для курьеров
│   ├── Customers.tsx         # Управление клиентами
│   ├── Dashboard.tsx         # Главная панель
│   ├── Groups.tsx            # Группы товаров
│   ├── Layout.tsx            # Основной layout
│   ├── Login.tsx             # Страница входа
│   ├── MobileMenu.tsx        # Мобильное меню
│   ├── MobileNav.tsx         # Мобильная навигация
│   ├── OfflineIndicator.tsx  # Индикатор офлайн-режима
│   ├── OrderCard.tsx         # Карточка заказа (детали)
│   ├── Orders.tsx            # Список заказов
│   ├── Products.tsx          # Управление товарами
│   ├── Reports.tsx           # Отчёты и аналитика
│   ├── Settings.tsx          # Настройки системы
│   └── ui/                   # UI компоненты (shadcn/ui)
├── utils/
│   ├── api.ts               # API клиент
│   ├── maps.ts              # Интеграция с картами
│   ├── pwa.ts               # PWA функции
│   ├── roles.ts             # Управление ролями
│   └── supabase/            # Supabase конфигурация
├── supabase/functions/server/
│   ├── index.tsx            # Backend сервер (Hono)
│   └── kv_store.tsx         # Key-Value хранилище
├── public/
│   ├── manifest.json        # PWA манифест
│   └── sw.js                # Service Worker
└── styles/
    └── globals.css          # Глобальные стили
```

### Технологии

**Frontend:**
- React 18 с TypeScript
- Tailwind CSS 4.0
- shadcn/ui компоненты
- Lucide React иконки
- Motion (Framer Motion) для анимаций

**Backend:**
- Supabase Edge Functions
- Hono (веб-фреймворк)
- Deno runtime

**База данных:**
- PostgreSQL (через Supabase)
- Key-Value Store

**PWA:**
- Service Worker для офлайн-режима
- IndexedDB для локального хранения
- Web App Manifest

**Интеграции:**
- Яндекс.Карты API
- Geolocation API
- Camera API

---

## 👥 Роли пользователей

### 1. Администратор (Admin)
**Полный доступ ко всем функциям системы**

**Права доступа:**
- ✅ Все права остальных ролей
- ✅ Управление пользователями
- ✅ Настройки системы
- ✅ Управление платформами продаж
- ✅ Доступ к аудиту
- ✅ Удаление любых данных

**Основные задачи:**
- Настройка и администрирование системы
- Управление пользователями и их правами
- Контроль всех бизнес-процессов
- Анализ работы системы через аудит

### 2. Менеджер продаж (Sales Manager)
**Работа с заказами и клиентами**

**Права доступа:**
- ✅ Создание и редактирование заказов
- ✅ Управление клиентами
- ✅ Просмотр товаров и цен
- ✅ Назначение курьеров
- ✅ Планирование доставок
- ✅ Изменение статусов заказов
- ✅ Просмотр отчётов по продажам
- ❌ Управление складом
- ❌ Изменение настроек системы

**Основные задачи:**
- Приём и обработка заказов
- Коммуникация с клиентами
- Назначение заказов курьерам
- Отслеживание выполнения заказов
- Контроль платежей

### 3. Кладовщик (Warehouse)
**Управление складом и товарами**

**Права доступа:**
- ✅ Управление товарами (добавление, редактирование)
- ✅ Серийный учёт товаров
- ✅ Управление группами товаров
- ✅ Изменение остатков
- ✅ Просмотр заказов (только для комплектации)
- ✅ Изменение статуса заказа на "Готов"
- ❌ Создание заказов
- ❌ Управление ценами
- ❌ Доступ к финансовым данным

**Основные задачи:**
- Приёмка товаров на склад
- Внесение серийных номеров
- Комплектация заказов
- Контроль остатков
- Инвентаризация

### 4. Бухгалтер/Аналитик (Accountant)
**Финансовая аналитика и отчётность**

**Права доступа:**
- ✅ Просмотр всех заказов (только чтение)
- ✅ Доступ к отчётам и аналитике
- ✅ Просмотр товаров и цен
- ✅ Просмотр истории платежей
- ✅ Экспорт данных
- ❌ Создание/редактирование заказов
- ❌ Управление товарами
- ❌ Изменение настроек

**Основные задачи:**
- Финансовый анализ
- Формирование отчётов
- Контроль оплат
- Анализ продаж
- Планирование ��акупок

### 5. Курьер (Courier)
**Доставка заказов**

**Права доступа:**
- ✅ Просмотр только своих назначенных заказов
- ✅ Изменение статуса доставки
- ✅ Загрузка фото подтверждения
- ✅ Навигация по адресам
- ✅ Работа в офлайн-режиме
- ❌ Просмотр других заказов
- ❌ Изменение данных заказа
- ❌ Доступ к складу или настройкам

**Основные задачи:**
- Доставка заказов клиентам
- Обновление статуса доставки
- Фотофиксация доставки
- Сбор подписи получателя
- Работа по маршруту

---

## 🧩 Функциональные модули

### 1. Модуль "Дашборд" (Dashboard)

**Описание:**
Главная панель с ключевыми метриками и статистикой.

**Функционал:**
- **Общая статистика** (зависит от роли):
  - Количество заказов (всего, новых, в работе)
  - Сумма продаж за период
  - Количество товаров на складе
  - Количество клиентов
  
- **Графики и диаграммы:**
  - График продаж по дням
  - Распределение заказов по статусам
  - Топ-продаваемые товары
  
- **Быстрые действия:**
  - Создать новый заказ
  - Добавить товар
  - Перейти к календарю доставок

**Доступ по ролям:**
- Админ: полная статистика
- Менеджер: продажи и заказы
- Кладовщик: склад и товары
- Бухгалтер: финансовая аналитика
- Курьер: свои доставки на сегодня

### 2. Модуль "Заказы" (Orders)

**Описание:**
Полное управление заказами от создания до завершения.

**Функционал:**

#### Создание заказа
- Выбор/создание клиента
- Добавление товаров в заказ
- Поиск товаров по названию/артикулу
- Автоматическое резервирование товаров
- Применение скидок (процент или сумма)
- Расчёт итоговой стоимости
- Выбор платформы продажи
- Указание типа доставки (Минск/Отправки/Самовывоз)

#### Редактирование заказа
- Изменение состава заказа
- Изменение данных клиента
- Изменение адреса доставки
- Корректировка цен и скидок
- Добавление комментариев

#### Управление статусами
Жизненный цикл заказа:
1. **Новый** (new) - только создан
2. **Подтверждён** (confirmed) - подтверждён клиентом
3. **Комплектуется** (picking) - на складе
4. **Готов** (ready) - скомплектован
5. **В пути** (shipped) - передан курьеру
6. **Завершён** (completed) - доставлен
7. **Отменён** (cancelled) - отменён

#### Планирование доставки
- Выбор даты доставки
- Выбор временного интервала:
  - 09:00-12:00
  - 12:00-15:00
  - 15:00-18:00
  - 18:00-21:00
- Назначение курьера
- Добавление комментария для курьера

#### Фильтрация и поиск
- По номеру заказа
- По имени/телефону клиента
- По адресу
- По статусу
- По типу доставки
- По платформе
- По курьеру
- По дате создания/доставки

#### Детальная информация о заказе
- Основная информация (номер, дата, статус)
- Данные клиента
- Состав заказа с серийными номерами
- История изменений
- Платёжная информация
- Информация о доставке
- Комментарии

**Доступ по ролям:**
- Админ: полный доступ
- Менеджер: создание, редактирование, управление
- Кладовщик: просмотр для комплектации
- Бухгалтер: только просмотр
- Курьер: только свои заказы

### 3. Модуль "Товары" (Products)

**Описание:**
Управление каталогом товаров и складскими остатками.

**Функционал:**

#### Карточка товара
- Название товара
- Артикул (SKU)
- Описание
- Цена
- Группа товаров
- Количество на складе
- Признак "Требует серийный номер"
- Признак "Аксессуар"
- Изображение товара

#### Серийный учёт
- Привязка серийных номеров к товарам
- Автоматическое резервирование по S/N
- Отслеживание истории S/N
- Статусы: "Доступен", "Зарезервирован", "Продан"

#### Управление остатками
- Добавление товара на склад
- Списание товара
- Корректировка остатков
- История движения товара
- Уведомления о низких остатках

#### Группы товаров
- Создание категорий
- Иерархическая структура
- Фильтрация по группам

#### Импорт/экспорт
- Массовое добавление товаров
- Экспорт каталога

**Доступ по ролям:**
- Админ: полный доступ
- Менеджер: просмотр, использование в заказах
- Кладовщик: управление товарами и остатками
- Бухгалтер: просмотр
- Курьер: нет доступа

### 4. Модуль "Клиенты" (Customers)

**Описание:**
База данных клиентов.

**Функционал:**
- Создание карточки клиента:
  - ФИО
  - Телефон (основной)
  - Дополнительный телефон
  - Email
  - Адрес (несколько адресов)
  - Комментарии
  
- История взаимодействий:
  - Список заказов клиента
  - Сумма покупок
  - Дата последнего заказа
  
- Поиск клиентов:
  - По имени
  - По телефону
  - По email
  
- Сегментация:
  - VIP клиенты
  - Новые клиенты
  - Активные/неактивные

**Доступ по ролям:**
- Админ: полный доступ
- Менеджер: создание, редактирование, просмотр
- Кладовщик: нет доступа
- Бухгалтер: просмотр
- Курьер: просмотр только для своих заказов

### 5. Модуль "Календарь доставок" (Calendar)

**Описание:**
Планирование и визуализация доставок на неделю.

**Функционал:**

#### Недельный вид
- 7 колонок (понедельник-воскресенье)
- Карточки заказов по дням
- Цветовая кодировка по статусам
- Индикация текущего дня

#### Карточка заказа в календаре
- Номер заказа
- Временной интервал
- Имя и телефон клиента
- Адрес доставки
- Тип доставки (бейдж)
- Статус заказа и доставки
- Назначенный курьер
- Сумма заказа

#### Фильтрация
- По типу доставки (Минск/Отправки/Самовывоз)
- Все/только назначенные курьеру

#### Навигация
- Переход на предыдущую/следующую неделю
- Быстрый переход на текущую неделю
- Отображение периода

#### Детальный просмотр заказа
- Клик по карточке открывает полную информацию
- На десктопе: модальное окно (Dialog)
- На мобильных: выдвижная панель (Drawer)
- Информация о клиенте, доставке, товарах, сумме

#### Мобильная адаптация
- На мобильных отображаются только дни с заказами
- Оптимизированный размер карточек
- Улучшенная читаемость

**Доступ по ролям:**
- Админ: все доставки
- Менеджер: все доставки
- Кладовщик: нет доступа
- Бухгалтер: просмотр
- Курьер: только свои доставки

### 6. Модуль "Отчёты" (Reports)

**Описание:**
Аналитика и отчётность по различным показателям.

**Функционал:**

#### Отчёт по продажам
- Период: день/неделя/месяц/год/произвольный
- Метрики:
  - Общая сумма продаж
  - Количество заказов
  - Средний чек
  - Конверсия
  
#### Графики
- График продаж по дням
- Круговая диаграмма по статусам заказов
- Распределение по типам доставки
- Топ товаров по продажам

#### Отчёт по товарам
- Остатки на складе
- Товары с низкими остатками
- Топ продаваемых товаров
- Товары без движения

#### Отчёт по курьерам
- Количество доставок
- Процент выполнения
- Средняя скорость доставки

#### Экспорт данных
- Экспорт в CSV
- Экспорт в Excel
- Печать отчёта

**Доступ по ролям:**
- Админ: все отчёты
- Менеджер: продажи и заказы
- Кладовщик: складские отчёты
- Бухгалтер: все отчёты
- Курьер: свои доставки

### 7. Модуль "Аудит" (Audit)

**Описание:**
Полный журнал всех операций в системе.

**Функционал:**
- Запись всех действий:
  - Кто выполнил
  - Что сделал
  - Когда
  - Какие данные изменены
  
- Типы операций:
  - Создание/изменение/удаление заказов
  - Изменение товаров
  - Изменение клиентов
  - Изменение настроек
  - Вход/выход пользователей
  
- Фильтрация:
  - По пользователю
  - По типу операции
  - По дате
  - По сущности
  
- Детализация:
  - Просмотр изменённых полей
  - Старые и новые значения
  - Контекст операции

**Доступ по ролям:**
- Админ: полный доступ
- Остальные роли: нет доступа

### 8. Модуль "Настройки" (Settings)

**Описание:**
Конфигурация системы и управление пользователями.

**Функционал:**

#### Управление пользователями
- Создание пользователей
- Назначение ролей
- Блокировка/разблокировка
- Изменение паролей
- Просмотр активности

#### Платформы продаж
- Добавление платформ (сайт, маркетплейсы и т.д.)
- Редактирование
- Отслеживание продаж по платформам

#### Настройки доставки
- Временные интервалы
- Зоны доставки
- Стоимость доставки

#### Общие настройки
- Название компании
- Контактная информация
- Настройки уведомлений

**Доступ по ролям:**
- Админ: полный доступ
- Остальные роли: нет доступа

### 9. Мобильное приложение для курьеров

**Описание:**
Специализированный интерфейс для курьеров с PWA функциями.

**Функционал:**

#### Список доставок
- Карточный вид заказов
- Сортировка по времени доставки
- Статусы доставки с цветовой кодировкой
- Быстрый доступ к действиям

#### Календарь доставок
- Просмотр доставок по дням
- Только дни с заказами
- Компактный вид для мобильных

#### Детали заказа (Bottom Sheet)
- Информация о клиенте
- Адрес доставки
- Состав заказа
- Сумма заказа
- Комментарии менеджера

#### Навигация
- Кнопка "Навигация" для открытия Яндекс.Карт
- Автоматическая передача адреса
- Построение маршрута от текущего местоположения

#### Быстрые действия
- **Позвонить клиенту**: прямой звонок
- **Отправить SMS**: быстрые шаблоны
  - "Еду к вам"
  - "Приехал"
  - "Задерживаюсь"
  - Свой текст

#### Управление статусом доставки
1. **Назначен** (assigned) - начальный статус
2. **В пути** (en_route) - курьер выехал
3. **Доставлено** (delivered) - успешная доставка
4. **Не доставлено** (failed) - неудачная попытка

#### Подтверждение доставки
- Загрузка фото подтверждения (обязательно)
- Указание ФИО получателя (обязательно)
- Автоматическая фиксация:
  - Времени доставки
  - GPS координат
  - Даты и времени

#### Офлайн-режим
- Работа без интернета
- Очередь операций (OfflineQueue)
- Автоматическая синхронизация при восстановлении связи
- Индикатор офлайн-режима
- Уведомления о статусе синхронизации

#### PWA функции
- Установка на главный экран
- Работает как нативное приложение
- Push-уведомления
- Работа в фоновом режиме
- Кэширование данных

**Доступ:**
- Только роль "Курьер"

---

## 💻 Технический стек

### Frontend

#### Основные технологии
- **React 18.3** - библиотека для построения UI
- **TypeScript** - типизация
- **Vite** - сборщик и dev-сервер
- **Tailwind CSS 4.0** - утилитарный CSS фреймворк

#### UI Компоненты
- **shadcn/ui** - библиотека готовых компонентов:
  - Dialog, Drawer - модальные окна
  - Button, Input, Select - формы
  - Card, Badge, Avatar - отображение данных
  - Table - таблицы
  - Calendar - календари
  - Chart - графики (Recharts)
  - Toast (Sonner) - уведомления
  - И многое другое (40+ компонентов)

#### Иконки и графика
- **Lucide React** - набор иконок
- **Motion (Framer Motion)** - анимации

#### Утилиты
- **date-fns** - работа с датами
- **Recharts** - графики и диаграммы

### Backend

#### Платформа
- **Supabase** - BaaS платформа
- **Supabase Edge Functions** - serverless функции
- **Deno** - runtime для Edge Functions

#### Web Framework
- **Hono** - быстрый веб-фреймворк для Edge
- **CORS** - поддержка кросс-доменных запросов

#### База данных
- **PostgreSQL** (через Supabase)
- **Key-Value Store** - для простого хранения данных

#### Авторизация
- **Supabase Auth** - встроенная авторизация

#### Хранилище файлов
- **Supabase Storage** - для хранения фото

### PWA

#### Service Worker
- Кэширование статических ресурсов
- Кэширование API запросов
- Стратегия: Network First, Cache Fallback
- Офлайн-страница

#### Manifest
- Метаданные приложения
- Иконки разных размеров
- Настройки отображения
- Цветовая схема

#### Offline Storage
- **IndexedDB** - для хранения данных офлайн
- Очередь операций
- Автоматическая синхронизация

### Интеграции

#### Карты
- **Яндекс.Карты API**
  - Геокодирование адресов
  - Построение маршрутов
  - Отображение карты

#### Geolocation
- **Geolocation API**
  - Определение местоположения курьера
  - Фиксация координат доставки

#### Camera
- **MediaDevices API**
  - Захват фото с камеры
  - Загрузка фото подтверждения

#### Communications
- **Tel: протокол** - звонки
- **SMS: протокол** - SMS сообщения

---

## 📱 Мобильная версия и PWA

### Progressive Web App

#### Что такое PWA?
PWA (Progressive Web App) - это веб-приложение, которое работает как нативное мобильное приложение.

#### Преимущества PWA
- ✅ Установка на домашний экран без App Store/Google Play
- ✅ Работает в полноэкранном режиме
- ✅ Офлайн-режим
- ✅ Push-уведомления
- ✅ Быстрая загрузка
- ✅ Автоматические обновления
- ✅ Работает на всех платформах (iOS, Android, Desktop)

### Установка PWA

#### На Android
1. Откройте приложение в Chrome
2. Нажмите меню (три точки)
3. Выберите "Добавить на главный экран"
4. Подтвердите установку

#### На iOS
1. Откройте приложение в Safari
2. Нажмите кнопку "Поделиться"
3. Выберите "На экран «Домой»"
4. Нажмите "Добавить"

### Офлайн-режим

#### Как работает
1. Service Worker кэширует все статические файлы
2. API запросы кэшируются в IndexedDB
3. При отсутствии интернета используются кэшированные данные
4. Операции записи сохраняются в очередь
5. При восстановлении связи очередь автоматически синхронизируется

#### Индикатор офлайн-режима
- Отображается в верхней части экрана
- Показывает количество операций в очереди
- Исчезает при восстановлении связи

#### Поддерживаемые операции офлайн
- Просмотр заказов (кэшированных)
- Изменение статуса доставки
- Загрузка фото подтверждения
- Фиксация данных получателя

### Мобильная адаптация

#### Адаптивный дизайн
- Breakpoint: 768px
- Мобильная навигация (нижнее меню)
- Оптимизированные размеры элементов
- Touch-friendly интерфейс

#### Мобильные компоненты
- **MobileNav** - нижняя навигация (5 иконок)
- **MobileMenu** - боковое меню (профиль, выход)
- **BottomSheet** - выдвижные панели
- **Drawer** - модальные окна снизу

#### Жесты
- Swipe для открытия меню
- Pull to refresh (в планах)
- Touch and hold (в планах)

### Оптимизация для мобильных

#### Производительность
- Lazy loading компонентов
- Оптимизация изображений
- Минимизация bundle size
- Code splitting

#### UX
- Крупные кнопки (минимум 44x44px)
- Читаемые шрифты
- Достаточные отступы
- Понятная навигация
- Быстрая обратная связь

---

## 🔌 Интеграции

### Яндекс.Карты

#### Функции
1. **Навигация к адресу**
   ```typescript
   openInYandexMaps(address: string)
   ```
   - Открывает Яндекс.Карты/Яндекс.Навигатор
   - Автоматически строит маршрут
   - От текущего местоположения до адреса

2. **Геокодирование** (в планах)
   - Преобразование адреса в координаты
   - Валидация адресов
   - Автодополнение адресов

#### Использование
```typescript
// Открыть навигацию
openInYandexMaps('Минск, ул. Ленина, 1');
```

### Телефония

#### Звонки
```typescript
makePhoneCall(phone: string)
```
- Открывает приложение телефона
- Автоматически набирает номер
- Работает на всех устройствах

#### SMS
```typescript
sendSMS(phone: string, message: string)
```
- Открывает приложение для SMS
- Предзаполняет текст сообщения
- Быстрые шаблоны сообщений

#### Шаблоны SMS для курьеров
- "Здравствуйте! Еду к вам с заказом. Курьер."
- "Здравствуйте! Я у подъезда. Курьер."
- "Здравствуйте! Задерживаюсь на 10-15 минут. Курьер."

### Geolocation

#### Определение местоположения
```typescript
getCurrentLocation(): Promise<{latitude, longitude}>
```
- Запрос разрешения у пользователя
- Получение текущих координат
- Точность до 10 метров

#### Использование
- Фиксация места доставки
- Построение маршрутов
- Отслеживание курьера (в планах)

### Camera API

#### Захват фото
- Доступ к камере устройства
- Съёмка фото подтверждения доставки
- Сжатие изображений
- Загрузка в Supabase Storage

#### Требования
- Фото обязательно для статуса "Доставлено"
- Рекомендуемый размер: до 2MB
- Форматы: JPEG, PNG

---

## 🔐 Backend и API

### Архитектура Backend

```
Frontend → API Client → Edge Function → Supabase Services
```

### API Client (`utils/api.ts`)

#### Основная функция
```typescript
apiCall(endpoint: string, options?: RequestInit): Promise<any>
```

#### Функционал
- Автоматическое добавление базового URL
- Добавление токена авторизации
- Обработка ошибок
- Поддержка офлайн-режима
- Retry механизм

#### Пример использования
```typescript
// GET запрос
const orders = await apiCall('/orders');

// POST запрос
const newOrder = await apiCall('/orders', {
  method: 'POST',
  body: JSON.stringify(orderData)
});

// PUT запрос
await apiCall(`/orders/${id}`, {
  method: 'PUT',
  body: JSON.stringify(updates)
});

// DELETE запрос
await apiCall(`/orders/${id}`, {
  method: 'DELETE'
});
```

### Edge Function Server (`supabase/functions/server/index.tsx`)

#### Технологии
- Hono web framework
- Deno runtime
- Supabase Admin SDK

#### Маршруты

##### Заказы
```
GET    /make-server-7614200b/orders          # Получить все заказы
GET    /make-server-7614200b/orders/:id      # Получить заказ по ID
POST   /make-server-7614200b/orders          # Создать заказ
PUT    /make-server-7614200b/orders/:id      # Обновить заказ
DELETE /make-server-7614200b/orders/:id      # Удалить заказ
POST   /make-server-7614200b/orders/:id/delivery-status  # Обновить статус доставки
```

##### Товары
```
GET    /make-server-7614200b/products        # Получить все товары
GET    /make-server-7614200b/products/:id    # Получить товар по ID
POST   /make-server-7614200b/products        # Создать товар
PUT    /make-server-7614200b/products/:id    # Обновить товар
DELETE /make-server-7614200b/products/:id    # Удалить товар
```

##### Клиенты
```
GET    /make-server-7614200b/customers       # Получить всех клиентов
POST   /make-server-7614200b/customers       # Создать клиента
PUT    /make-server-7614200b/customers/:id   # Обновить клиента
DELETE /make-server-7614200b/customers/:id   # Удалить клиента
```

##### Пользователи
```
GET    /make-server-7614200b/users           # Получить всех пользователей
POST   /make-server-7614200b/users           # Создать пользователя
PUT    /make-server-7614200b/users/:id       # Обновить пользователя
DELETE /make-server-7614200b/users/:id       # Удалить пользователя
```

##### Другие
```
GET    /make-server-7614200b/groups          # Группы товаров
GET    /make-server-7614200b/platforms       # Платформы продаж
GET    /make-server-7614200b/audit           # Журнал аудита
GET    /make-server-7614200b/reports         # Отчёты
```

#### Middleware
- **CORS** - разрешение кросс-доменных запросов
- **Logger** - логирование всех запросов
- **Error Handler** - обработка ошибок

#### Авторизация
```typescript
// Проверка токена
const token = request.headers.get('Authorization')?.split(' ')[1];
const { data: { user }, error } = await supabase.auth.getUser(token);

if (!user) {
  return new Response('Unauthorized', { status: 401 });
}
```

### Key-Value Store (`supabase/functions/server/kv_store.tsx`)

#### Функции
```typescript
// Получить значение
get(key: string): Promise<any>

// Установить значение
set(key: string, value: any): Promise<void>

// Удалить значение
del(key: string): Promise<void>

// Получить несколько значений
mget(keys: string[]): Promise<any[]>

// Установить несколько значений
mset(entries: [string, any][]): Promise<void>

// Удалить несколько значений
mdel(keys: string[]): Promise<void>

// Получить по префиксу
getByPrefix(prefix: string): Promise<any[]>
```

#### Использование
```typescript
import * as kv from './kv_store.tsx';

// Сохранить заказ
await kv.set(`order:${orderId}`, orderData);

// Получить заказ
const order = await kv.get(`order:${orderId}`);

// Получить все заказы
const orders = await kv.getByPrefix('order:');

// Удалить заказ
await kv.del(`order:${orderId}`);
```

### Supabase Services

#### Auth
- Регистрация пользователей
- Вход/выход
- Управление сессиями
- JWT токены
- Роли и права доступа

#### Database
- PostgreSQL
- Автоматические бэкапы
- Репликация
- Индексы

#### Storage
- Хранение файлов
- Приватные/публичные бакеты
- Signed URLs
- Автоматическое сжатие изображений

---

## 🛡️ Безопасность

### Авторизация и аутентификация

#### Система ролей
- Каждый пользователь имеет одну роль
- Роль определяет доступ к функциям
- Проверка прав на frontend и backend

#### JWT токены
- Безопасное хранение в localStorage
- Автоматическое обновление
- Время жизни: 7 дней
- Автоматический logout при истечении

#### Защита маршрутов
```typescript
// Проверка авторизации
if (!user) {
  redirect('/login');
}

// Проверка прав
if (!permissions.canCreateOrders) {
  return <div>Нет доступа</div>;
}
```

### Защита данных

#### На уровне API
- Проверка токена в каждом запросе
- Валидация входных данных
- Санитизация данных
- SQL injection защита (параметризованные запросы)

#### На уровне базы данных
- Row Level Security (RLS)
- Политики доступа
- Шифрование данных в покое
- Шифрование соединений (SSL/TLS)

#### На уровне приложения
- XSS защита (React автоматически экранирует)
- CSRF защита
- Content Security Policy
- HTTPS only

### Аудит безопасности

#### Логирование
- Все действия пользователей
- Попытки несанкционированного доступа
- Изменения критичных данных
- Ошибки и исключения

#### Мониторинг
- Отслеживание подозрительной активности
- Уведомления о проблемах
- Регулярные проверки логов

### Конфиденциальность

#### GDPR compliance
- Право на удаление данных
- Право на экспорт данных
- Согласие на обработку
- Минимизация сбора данных

#### Персональные данные
- ФИО клиентов
- Телефоны
- Адреса
- История покупок

#### Защита
- Доступ только авторизованным пользователям
- Логирование доступа к личным данным
- Регулярное удаление старых данных

---

## 🚀 Развертывание

### Требования

#### Supabase проект
1. Создать проект на supabase.com
2. Получить URL и Anon Key
3. Настроить базу данных

#### Environment Variables
```bash
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

### Развертывание Frontend

#### Vercel (рекомендуется)
```bash
# Установить Vercel CLI
npm i -g vercel

# Деплой
vercel

# Добавить переменные окружения
vercel env add SUPABASE_URL
vercel env add SUPABASE_ANON_KEY
```

#### Netlify
```bash
# Установить Netlify CLI
npm i -g netlify-cli

# Деплой
netlify deploy --prod

# Добавить переменные
netlify env:set SUPABASE_URL your-url
netlify env:set SUPABASE_ANON_KEY your-key
```

#### Другие хостинги
- GitHub Pages (только статика)
- Cloudflare Pages
- AWS S3 + CloudFront
- Любой статический хостинг

### Развертывание Backend (Edge Functions)

```bash
# Установить Supabase CLI
npm i -g supabase

# Логин
supabase login

# Линк к проекту
supabase link --project-ref your-project-ref

# Деплой функций
supabase functions deploy server

# Установить секреты
supabase secrets set SUPABASE_URL=your-url
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=your-key
```

### Настройка базы данных

#### Создание таблицы KV Store
```sql
CREATE TABLE IF NOT EXISTS kv_store_7614200b (
  key TEXT PRIMARY KEY,
  value JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_kv_key_prefix 
ON kv_store_7614200b (key text_pattern_ops);
```

#### Row Level Security
```sql
ALTER TABLE kv_store_7614200b ENABLE ROW LEVEL SECURITY;

-- Политика для авторизованных пользователей
CREATE POLICY "Allow all for authenticated users" 
ON kv_store_7614200b 
FOR ALL 
TO authenticated 
USING (true);
```

### Настройка Storage

#### Создание бакета для фото
```sql
-- Создать бакет через Supabase Dashboard
-- Название: make-7614200b-delivery-photos
-- Приватный доступ
```

### PWA настройка

#### Service Worker
Файл уже настроен: `/public/sw.js`

#### Manifest
Файл уже настроен: `/public/manifest.json`

#### Иконки
Добавить иконки в `/public/icons/`:
- icon-72x72.png
- icon-96x96.png
- icon-128x128.png
- icon-144x144.png
- icon-152x152.png
- icon-192x192.png
- icon-384x384.png
- icon-512x512.png

### SSL/HTTPS

#### Важно!
PWA требует HTTPS для работы Service Worker и других функций.

#### Настройка
- Vercel/Netlify автоматически предоставляют SSL
- Для собственного домена: использовать Let's Encrypt
- Supabase всегда использует HTTPS

### Мониторинг

#### Логи
```bash
# Просмотр логов Edge Function
supabase functions logs server

# Следить за логами в реальном времени
supabase functions logs server --follow
```

#### Метрики
- Использовать Supabase Dashboard
- Настроить алерты
- Интеграция с Sentry (опционально)

---

## 📖 Руководство пользователя

### Для администратора

#### Первый запуск
1. Создать первого пользователя (админа) через Supabase Dashboard
2. Войти в систему
3. Настроить платформы продаж (Настройки → Платформы)
4. Создать группы товаров (Товары → Группы)
5. Добавить пользователей (Настройки → Пользователи)

#### Создание пользователя
1. Перейти в "Настройки" → "Пользователи"
2. Нажать "+ Добавить пользователя"
3. Заполнить данные:
   - Email
   - Пароль
   - Имя
   - Роль
4. Нажать "Создать"

#### Управление правами
- Права определяются ролью
- Для изменения прав - изменить роль пользователя
- Блокировка пользователя: выключить toggle "Активен"

### Для менеджера продаж

#### Создание заказа
1. Перейти в "Заказы"
2. Нажать "+ Новый заказ"
3. Выбрать или создать клиента
4. Добавить товары:
   - Поиск по названию/артикулу
   - Указать количество
   - Применить скидку (если нужно)
5. Указать адрес доставки
6. Выбрать платформу продаж
7. Выбрать тип доставки
8. Нажать "Создать заказ"

#### Подтверждение заказа
1. Открыть заказ (клик по номеру)
2. Связаться с клиентом (позвонить)
3. Подтвердить состав и адрес
4. Изменить статус на "Подтверждён"
5. Указать дату доставки
6. Выбрать временной интервал
7. Нажать "Сохранить"

#### Назначение курьера
1. Открыть заказ
2. Убедиться, что статус "Подтверждён" или выше
3. Убедиться, что указана дата доставки
4. В поле "Курьер" выбрать курьера
5. Добавить комментарий для курьера (если нужно)
6. Нажать "Сохранить"

#### Отслеживание заказа
1. Перейти в "Календарь"
2. Найти заказ по дате
3. Клик по карточке заказа для деталей
4. Проверить статус доставки:
   - Назначен (серый)
   - В пути (оранжевый)
   - Доставлено (зелёный)

### Для кладовщика

#### Добавление товара
1. Перейти в "Товары"
2. Нажать "+ Добавить товар"
3. Заполнить данные:
   - Название
   - Артикул (SKU)
   - Цена
   - Группа
   - Количество
   - Требует серийный номер (для техники)
   - Аксессуар (для аксессуаров)
4. Нажать "Создать"

#### Приёмка товара на склад
1. Найти товар в списке
2. Открыть карточку товара
3. Если товар с серийными номерами:
   - Добавить каждый S/N отдельно
   - Указать количество = 1 для каждого
4. Если обычный товар:
   - Увеличить количество

#### Комплектация заказа
1. Перейти в "Заказы"
2. Фильтр: статус "Подтверждён"
3. Открыть заказ
4. Просмотреть состав
5. Собрать товары
6. Проверить серийные номера
7. Изменить статус на "Готов"
8. Нажать "Сохранить"

#### Контроль остатков
1. Перейти в "Товары"
2. Просмотреть колонку "Остаток"
3. Товары с низким остатком (< 5) выделены
4. Сформировать заявку на закупку

### Для бухгалтера

#### Просмотр отчёта по продажам
1. Перейти в "Отчёты"
2. Выбрать период (день/неделя/месяц/год)
3. Или указать произвольный период
4. Нажать "Сформировать"
5. Просмотреть:
   - Общую сумму продаж
   - Количество заказов
   - Средний чек
   - График продаж
   - Распределение по статусам

#### Экспорт данных
1. Сформировать отчёт
2. Нажать "Экспорт"
3. Выбрать формат (CSV/Excel)
4. Файл загрузится автоматически

#### Контроль оплат
1. Перейти в "Заказы"
2. Колонка "Оплачено" показывает статус
3. Фильтр: "Неоплаченные"
4. Просмотреть список
5. Связаться с менеджером/клиентом

### Для курьера

#### Установка мобильного приложения

**Android:**
1. Открыть ссылку в Chrome
2. Меню → "Добавить на главный экран"
3. Подтвердить

**iOS:**
1. Открыть ссылку в Safari
2. Кнопка "Поделиться"
3. "На экран «Домой»"
4. "Добавить"

#### Просмотр доставок
1. Открыть приложение
2. Список сегодняшних доставок
3. Или перейти в "Календарь"
4. Клик по заказу для деталей

#### Начало доставки
1. Открыть заказ
2. Нажать "Навигация" → откроется Яндекс.Карты
3. Следовать по маршруту
4. При выезде: изменить статус на "В пути"

#### В процессе доставки
- **Позвонить клиенту**: нажать кнопку телефона
- **Отправить SMS**: нажать кнопку сообщения, выбрать шаблон
- **Проблемы с адресом**: позвонить менеджеру

#### Подтверждение доставки
1. Приехать к клиенту
2. Передать заказ
3. Сделать фото (упаковка/товар/клиент с товаром)
4. Узнать ФИО получателя
5. В приложении:
   - Нажать "Сделать фото"
   - Сфотографировать
   - Ввести ФИО получателя
   - Нажать "Доставлено"
6. Готово! Система зафиксирует:
   - Время доставки
   - GPS координаты
   - Фото
   - ФИО получателя

#### Неудачная доставка
1. Если клиент не отвечает/отказался
2. Изменить статус на "Не доставлено"
3. Указать причину в комментарии
4. Связаться с менеджером

#### Работа офлайн
1. Все действия сохраняются локально
2. В верхней части экрана: индикатор офлайн
3. При восстановлении связи:
   - Автоматическая синхронизация
   - Уведомление об успехе
4. Можно работать весь день без интернета!

---

## 📊 Статистика и метрики

### Ключевые показатели

#### Продажи
- Общая сумма продаж
- Количество заказов
- Средний чек
- Конверсия (завершённые/все заказы)
- Рост продаж (по сравнению с прошлым периодом)

#### Склад
- Количество товаров
- Общая стоимость остатков
- Товары с низкими остатками
- Оборачиваемость товаров

#### Доставка
- Количество доставок
- Процент успешных доставок
- Среднее время доставки
- Загрузка курьеров

#### Клиенты
- Общее количество
- Новые клиенты за период
- Повторные покупки
- Средняя сумма покупки

---

## 🔄 Обновления и поддержка

### История обновлений
См. файлы:
- `MOBILE_PWA.md` - Мобильная версия и PWA
- `UNIFIED_INTERFACE.md` - Единый интерфейс
- `CALENDAR_RESTORED.md` - Календарь доставок
- `ROLES_FULL_FUNCTIONALITY.md` - Полный функционал ролей
- `SETTINGS_UPDATE.md` - Обновление настроек

### Известные проблемы
- Нет (на данный момент)

### Планы развития
1. **Push-уведомления** для курьеров
2. **Чат** между менеджером и курьером
3. **Отслеживание курьера** на карте в реальном времени
4. **Автоматическое построение маршрута** для нескольких доставок
5. **Интеграция с 1С** для синхронизации товаров
6. **Маркетинг** - рассылки клиентам
7. **Программа лояльности** - скидки, бонусы
8. **Аналитика** - расширенные отчёты и прогнозы
9. **Мобильное приложение** для менеджеров

### Обратная связь
Для сообщений об ошибках или предложений создайте issue в репозитории.

---

## 📝 Заключение

Данная CRM-система представляет собой полноценное решение для управления онлайн-магазином техники с акцентом на:

✅ **Простоту использования** - интуитивный интерфейс  
✅ **Мобильность** - PWA для курьеров  
✅ **Надёжность** - офлайн-режим и синхронизация  
✅ **Безопасность** - система ролей и аудит  
✅ **Масштабируемость** - готовность к росту бизнеса  

Система успешно автоматизирует все бизнес-процессы от приёма заказа до доставки клиенту, обеспечивая контроль на каждом этапе.

---

**Версия документации:** 1.0  
**Дата:** 11 октября 2025  
**Статус:** Актуальная
